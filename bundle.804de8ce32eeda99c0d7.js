(()=>{"use strict";class e{constructor(){this.lang="en",this.catalog=[],this.__ready=!1,this.__loaded=!1,this.waiters=[],this.server=new t,this.score=0,this.config={},setTimeout((()=>{this.create()}),0)}reachGoal(e){}loading(e=0){}sendProgress(e=0){}goalAchievement(e){return Promise.resolve(!0)}getOption(e){return this.config[e]}setOption(e,t){this.config[e]=t}getSignature(){return""}create(){this.__ready=!0}getStorage(){return Promise.resolve(null)}gameReady(){}callWaiters(){this.waiters.forEach((e=>{try{e(this.__loaded)}catch(e){console.error(e)}}))}review(){return Promise.resolve(!1)}canReview(){return Promise.resolve(!1)}isReview(){return Promise.resolve(!1)}getLang(){return Promise.resolve(this.lang)}init(){return this.__ready?Promise.resolve(this.__loaded):new Promise((e=>{this.waiters.push(e)}))}save(e,t=!1){return Promise.all([this.saveOnServer(e,t)]).catch((e=>{}))}saveOnServer(e,t=!1){return this.server.save(e,this.score,t)}load(e){return this.loadFromServer().then((e=>e||null)).catch((()=>null))}loadFromServer(){return this.server.load()}getId(){return"1"}isAuth(){return Promise.resolve(!1)}buy(...e){return Promise.reject(!1)}consumePurchase(...e){return Promise.resolve(!1)}getCatalog(){return this.catalog}getPurchase(){return Promise.resolve([])}auth(){return Promise.reject()}setScore(e,t=!0){return this.score=Number(e)||0}getRank(e=!0){return this.server.getLb(0,0).then((e=>{var t;return(null===(t=null==e?void 0:e.player)||void 0===t?void 0:t.rank)||0})).catch((e=>0))}getScore(e=!0){return e||this.score<=0?this.server.getLb(0,0).then((e=>{var t;return(null===(t=null==e?void 0:e.player)||void 0===t?void 0:t.score)||0})).catch((e=>0)):Promise.resolve(this.score)}addScore(e=1){return this.getScore().then((t=>this.setScore(t+e)))}entrieFormat(e){return Promise.resolve((()=>{try{return{id:e.player_id,score:e.score,rank:e.rank,title:"",avatar:"",extra_data:e.extra_data}}catch(e){return{id:"",score:0,rank:0,avatar:"",title:""}}})())}getLbData(){return this.server.getLb().then((e=>{console.log("LB TEST",e);const t=e.top||[],r=e.nearby||[],s=e.player,i=[],o=e=>{e&&!i.find((t=>t.player_id===e.player_id))&&i.push(e)};return t.forEach(o),r.forEach(o),o(s),Promise.all(i.map((e=>this.entrieFormat(e))))})).catch((()=>[]))}showLb(){return Promise.resolve(!1)}showFullscreenAds(){return Promise.resolve(!1)}showRewardedAds(){return Promise.resolve(!1)}showStickyBanner(){}updateBanner(){this.showStickyBanner()}hideStickyBanner(){}sendPost(...e){return Promise.resolve(!1)}canInvite(){return Promise.resolve(!1)}invite(...e){return Promise.resolve(!1)}member(...e){return Promise.resolve(!1)}isMember(){return Promise.resolve(!1)}openGroup(){}canMember(){return Promise.resolve(!1)}favorite(...e){return Promise.resolve(!1)}isFavorite(){return Promise.resolve(!1)}canAddToFavorite(...e){return Promise.resolve(!1)}matchBonuses(){return Promise.resolve(0)}isSignedForEvents(){return Promise.resolve(!1)}canSignedForEvents(){return Promise.resolve(!1)}signedForEvents(){return Promise.resolve(!1)}canCreateShortcut(){return Promise.resolve(!1)}createShortcut(){return Promise.resolve(!1)}}class t{constructor(){this.game_code="",this.player_id="",this.actualData="",this.lastSaveTime=0,this.timer=null,this.saveStep=1e3}init(e="",t=""){this.game_code=e,this.player_id=t,console.log("SERVER init",this.game_code,this.player_id)}setExtraData(e){try{this.extra_data=e?JSON.stringify(e):void 0}catch(e){console.error(e)}}save(e,t,r=!1){if(this.score=t,!this.game_code||!this.player_id)return Promise.resolve(!1);const s=JSON.stringify(e);if(this.actualData===s)return Promise.resolve(!0);if(this.actualData=s,this.timer)return r?(clearTimeout(this.timer),this.timer=null,this.__save()):Promise.resolve(!0);const i=Date.now();return this.lastSaveTime>i-this.saveStep?new Promise((e=>{this.timer=setTimeout((()=>{this.timer=null,this.__save().then(e)}),this.saveStep+this.lastSaveTime-i)})):this.__save()}__save(e=3){if(e<=0)return Promise.resolve(!1);const t=this.actualData;return this.lastSaveTime=Date.now(),this.request("https://bbb.dra.games/api/save-data",{game_code:this.game_code,player_id:this.player_id,game_data:t,score:this.score,extra_data:this.extra_data}).then((e=>(console.log("SERVER saved",t),Promise.resolve(e)))).catch((r=>(console.error("SERVER save error",r),this.actualData!==t?Promise.resolve(!1):this.__save(e-1))))}load(e=2){return this.game_code&&this.player_id?this.request("https://bbb.dra.games/api/get-data",{game_code:this.game_code,player_id:this.player_id}).then((e=>{var t;console.log("SERVER loaded",e);const r=(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.game_data)||"";return r&&(this.actualData=r),Promise.resolve(r?JSON.parse(r):null)})).catch((t=>(console.log("SERVER load error",t),e<=0?Promise.resolve(null):this.load(e-1)))):Promise.resolve(null)}getLb(e=10,t=6){return this.game_code&&this.player_id?this.request("https://bbb.dra.games/api/players/get-leaderboard",{game_code:this.game_code,player_id:this.player_id,top_limit:e,nearby_limit:t}).then((e=>(console.log(e),Promise.resolve((null==e?void 0:e.data)||{})))).catch((e=>(console.error(e),Promise.resolve(null)))):Promise.reject()}request(e,t=null,r="application/json"){return new Promise(((s,i)=>{const o=new XMLHttpRequest;o.open("POST",e,!0),o.setRequestHeader("Content-type",r),o.onreadystatechange=e=>{4==o.readyState&&(200==o.status?s(JSON.parse(o.responseText)):i(JSON.parse(o.responseText)))},o.send(JSON.stringify(t))}))}}const r=new class{constructor(){this.pull={}}addEvent(e){this.pull[e]||(this.pull[e]=[])}addListener(e,t){var r;return this.addEvent(e),null===(r=this.getListenersFor(e))||void 0===r||r.push(t),t}addOnceListener(e,t){var r;this.addEvent(e);const s=(...r)=>{this.removeListenerFor(e,s),t&&t(...r)};return null===(r=this.getListenersFor(e))||void 0===r||r.push(s),s}removeEvent(e){this.pull[e]&&delete this.pull[e]}removeListener(e){Object.keys(this.pull).forEach((t=>{this.removeListenerFor(t,e)}))}removeListenerFor(e,t){const r=this.getListenersFor(e);if(!r||!r.length)return;const s=r.indexOf(t);-1!==s&&r.splice(s,1)}callEvent(e,...t){const r=this.pull[e];r&&r.slice().forEach((e=>e.apply(e,t)))}getListenersFor(e){return this.pull[e]}clear(){this.pull={}}waiter(e){return new Promise((t=>{this.addOnceListener(e,t)}))}waiters(...e){return Promise.all(e.map((e=>this.waiter(e))))}};class s{constructor(){this.last=0,this.min=3e4,this.fapi=null}init(e){this.fapi=e}show(){const e=[];return new Promise((t=>{try{if(!this.fapi)return t(!1,"fapi is not defined");const s=Date.now();if(Math.abs(s-this.last)<this.min)return t(!1);this.last=s;let i=!1;e.push(r.addListener("showAd_ok",(e=>{"ad_prepared"===e.data?i=!0:"ad_shown"===e.data&&t(!0)}))),e.push(r.addListener("showAd_error",(()=>{t(!1)}))),this.fapi.UI.showAd(),setTimeout((()=>{i||t(!1)}),1e4)}catch(e){t(!1,e)}})).then((t=>(e.forEach((e=>r.removeListener(e))),t)))}}class i{constructor(){this.fapi=null,this.ready=!1,this.loading=!1,this.block=!1}init(e){console.log("REWARD init"),this.fapi=e,this.load()}load(){if(this.block||!this.fapi||this.ready||this.loading)return;this.loading=!0;const e=[],t=()=>{this.loading=!1,e.forEach((e=>r.removeListener(e))),this.ready||setTimeout((()=>this.load()),1e4)};try{e.push(r.addListener("loadAd_ok",(e=>{this.ready=!0,t()}))),e.push(r.addListener("loadAd_error",(e=>{t()}))),this.fapi.UI.loadAd()}catch(e){console.error(e),this.loading=!1}}show(){const e=[];return new Promise((t=>{try{if(!this.fapi)return t(!1,"fapi is not defined");if(!this.ready)return t(!1);let s=!1;e.push(r.addListener("showLoadedAd_ok",(e=>{t(!0)}))),e.push(r.addListener("showLoadedAd_error",(e=>{"mp4_not_supported"===e.data&&(this.block=!0),t(!1)}))),this.fapi.UI.showLoadedAd(),setTimeout((()=>{s||t(!1)}),2e4)}catch(e){console.error(e),t(!1,e)}})).then((t=>(this.ready=!1,setTimeout((()=>this.load()),1e3),e.forEach((e=>r.removeListener(e))),t)))}}class o{constructor(){this.fapi=null,this.switch=!1,this.visible=!1,this.ready=!1,this.side="bottom",this.block=!1}search(){return!this.fapi||this.block?Promise.resolve(!1):new Promise((e=>{r.addOnceListener("requestBannerAds_ok",(t=>{this.ready=!0,e(!0)})),r.addOnceListener("requestBannerAds_error",(t=>{setTimeout((()=>{r.addOnceListener("requestBannerAds_error",(t=>{e(!1)})),this.fapi.invokeUIMethod("requestBannerAds")}),2e3)})),this.fapi.invokeUIMethod("requestBannerAds")}))}update(){!this.block&&this.visible&&this.search().then((e=>{e&&this.visible&&this.__show()}))}__show(){this.ready&&this.fapi.invokeUIMethod("showBannerAds",this.side)}__hide(){this.fapi.invokeUIMethod("hideBannerAds")}init(e){this.fapi=e,r.addOnceListener("getBannerFormats_ok",(t=>{let s="",i=null;const o=JSON.parse(t).supported;s="vertical_outer",this.side="right",i=o[s],i?(r.addOnceListener("setBannerFormat_ok",(()=>{this.search()})),r.addOnceListener("setBannerFormat_error",(()=>{this.block=!0})),e.invokeUIMethod("setBannerFormat",s)):this.block=!0})),r.addOnceListener("getBannerFormats_error",(()=>{setTimeout((()=>{e.invokeUIMethod("getBannerFormats")}),2e3)})),e.invokeUIMethod("getBannerFormats")}show(){this.switch||(this.switch=!0,this.check())}hide(){this.switch&&(this.switch=!1,this.check())}check(){if(!this.ready)return;const e=[],t=()=>{e.forEach((e=>r.removeListener(e)))};e.push(r.addOnceListener("isBannerAdsVisible_ok",(e=>{Boolean(e)&&!this.visible?this.__hide():!Boolean(e)&&this.visible&&this.__show(),t()}))),e.push(r.addOnceListener("isBannerAdsVisible_error",(e=>{t()}))),this.fapi.invokeUIMethod("isBannerAdsVisible")}}var a=function(e,t,r,s){return new(r||(r=Promise))((function(i,o){function a(e){try{h(s.next(e))}catch(e){o(e)}}function n(e){try{h(s.throw(e))}catch(e){o(e)}}function h(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,n)}h((s=s.apply(e,t||[])).next())}))};window.includeScript("//api.ok.ru/js/fapi5.js");let n=!1,h=0,l=null;document.getElementById("statusMessage");const c=document.getElementById("showInterstitial"),d=document.getElementById("showReward"),u=document.getElementById("saveGame"),m=document.getElementById("loadGame"),p=document.getElementById("addStat"),v=document.getElementById("removeStat");function g(e){return a(this,void 0,void 0,(function*(){if(n&&l)try{if("reward"===e){const e=yield l.showRewardedAds();h=Date.now(),console.log("watched = ",e),console.log(e?"[success] Награда получена!":"[warning] Реклама закрыта до завершения")}else yield l.showFullscreenAds(),h=Date.now(),console.log(`[success] Реклама ${e} показана`)}catch(t){console.error(`[error] Ошибка ${e}:`,t)}else console.warn(`[warning] Адаптер не готов: Показ ${e} рекламы`)}))}null==c||c.addEventListener("click",(()=>g("interstitial"))),null==d||d.addEventListener("click",(()=>g("reward"))),null==u||u.addEventListener("click",(function(){return a(this,void 0,void 0,(function*(){if(n&&l){console.log("adapter =",l);try{const e={};yield l.save(e),console.log("[success] Данные сохранены")}catch(e){console.error("[error] Ошибка сохранения:",e)}}else console.warn("save (mock)")}))})),null==m||m.addEventListener("click",(function(){return a(this,void 0,void 0,(function*(){if(!n||!l)return console.warn("load (mock)"),null;try{const e=yield l.load();return console.log("[success] Данные загружены",e),e}catch(e){return console.error("[error] Ошибка загрузки:",e),null}}))})),null==p||p.addEventListener("click",(function(){n&&l&&l.reachGoal("stat_added"),console.log("Сохранение статистики")})),null==v||v.addEventListener("click",(function(){n&&l&&l.reachGoal("stat_removed"),console.log("Удаление статистики")})),l=new class extends e{constructor(){super(...arguments),this.fapi=window.FAPI,this.params={},this.storageCache={},this.fullscreenAds=new s,this.rewardedAds=new i,this.bannerAds=new o,this.group_id=70000007535724,this.appId=512002798511,this.appUrl="https://ok.ru/game/"+this.appId}create(){this.initParams(),this.lang="ru",Promise.all([this.initFapi(),this.loadCatalog()]).then((()=>{this.adapterReady()}))}initFapi(){return new Promise((e=>{this.fapi.init(this.params.api_server,this.params.apiconnection,(()=>{this.__loaded=!0,e()}),(()=>{e()}))}))}getCurrency(e=0){return"OK"}loadCatalog(){return fetch("https://dravk.ru/slova_ok/shop/items.json?t="+Date.now()).then((e=>e.json())).then((e=>(this.catalog=Object.keys(e).map((t=>{const r=e[t],s=r.price;return{id:t,title:r.title||"",descr:r.descr||"",price:s+" "+this.getCurrency(s),priceValue:s}})),!0))).catch((e=>(console.error("loadCatalog",e),!1)))}canMember(){return this.isMember().then((e=>!e))}isMember(){return new Promise((e=>{this.fapi.Client.call({method:"group.getUserGroupsByIds",uids:this.getId(),group_id:String(this.group_id)},((t,r,s)=>e("ok"===t&&!!r.length&&["active","admin","moderator"].includes(r[0].status.toLowerCase()))))}))}matchBonuses(){return Promise.all([this.isMember()]).then((e=>e.filter((e=>e)).length-.5))}initEvents(){window.API_callback=(e,t,s)=>{r.callEvent(e+"_"+t,s)}}initParams(){this.params=this.fapi.Util.getRequestParameters()}initAds(){this.fullscreenAds.init(this.fapi),this.rewardedAds.init(this.fapi),this.bannerAds.init(this.fapi)}adapterReady(){this.initParams(),this.initServer(),this.initEvents(),this.initAds(),this.__ready=!0,this.callWaiters()}getId(){return this.params.logged_user_id}getSignature(){return this.params.sig}initServer(){this.server.init("Adapter_testOK",this.getId())}save(e){return Promise.all([this.saveOnServer(e),this.okSave(e)]).catch((e=>{console.error(e)}))}okSave(e){Object.keys(e).forEach((t=>{this.__okSaveItem(t,e[t])}))}__okSaveItem(e,t){try{if(this.storageCache[e]===t)return;this.storageCache[e]=t,this.fapi.Client.call({method:"storage.set",key:e,value:t},((...r)=>{console.log("save",e,t,r)}))}catch(e){console.error(e)}}load(e){return Promise.all([this.loadFromServer(),this.okLoad(e)]).then((e=>(console.log("LOADS",e),e.find((e=>!!e))||null))).catch((e=>(console.error(e),null)))}okLoad(e=[]){return new Promise(((t,r)=>{try{this.fapi.Client.call({method:"storage.get",keys:e},((e,r)=>{console.log("FAPI get",r);try{if("ok"===e){const e=r.data||{};Object.keys(e).forEach((t=>{this.storageCache[t]=e[t]})),t(r.data||null)}}catch(e){console.error(e)}t(null)}))}catch(e){console.error(e),t(null)}}))}showFullscreenAds(){return this.fullscreenAds.show()}showRewardedAds(){return this.rewardedAds.show()}showStickyBanner(){this.bannerAds.show()}updateBanner(){this.bannerAds.update()}hideStickyBanner(){this.bannerAds.hide()}isAuth(){return Promise.resolve(!0)}canInvite(){return Promise.resolve(!0)}invite(e=""){return this.fapi.UI.showInvite(e),this.eventToPromise("showInvite").then((e=>!0)).catch((e=>!1))}member(...e){const t=this.eventToPromise("joinGroup").then((()=>!0)).catch((()=>!1));return this.fapi.UI.joinGroup(this.group_id,!0),t}sendPost(e=""){return e=e.replace("{url}",this.appUrl),this.fapi.UI.postMediatopic({media:[{type:"text",text:e},{type:"link",url:this.appUrl}]}),this.eventToPromise("postMediatopic").then((()=>!0)).catch((()=>!1))}isReview(){return new Promise((e=>{this.fapi.Client.call({method:"apps.getAppUserRating",app_id:this.appId},((t,r,s)=>{s&&console.error(s),e("ok"===t&&r.success&&r.rating>0)}))}))}canReview(){return new Promise((e=>{this.fapi.Client.call({method:"apps.getAppUserRating",app_id:this.appId},((t,r,s)=>{s&&console.error(s),e("ok"===t&&!(r.success&&r.rating>0))}))}))}review(){return this.fapi.UI.showRatingDialog(),this.eventToPromise("showRatingDialog").then((()=>!0)).catch((e=>(console.error(e),!1)))}getUsersData(e){return new Promise((t=>{this.fapi.Client.call({method:"users.getInfo",fields:"first_name,last_name,pic128x128,uid,gender",uids:e,emptyPictures:!0},((e,r,s)=>t("ok"!==e?[]:r)))}))}getLbData(){return super.getLbData().then((e=>this.getUsersData(e.map((e=>e.id))).then((t=>(console.log("users data",t,e.map((e=>e.id))),t.forEach((t=>{const r=e.find((e=>Number(e.id)==t.uid));if(!r)return;const s=t.first_name||"",i=t.last_name||"";r.avatar=t.pic128x128||"https://dravk.ru/slova_ok/avatars/"+("female"===t.gender?"f":"m")+".png",r.title=s+(i?" "+i:"")||""})),e)))))}tryGetPurchase(){let e=5;return new Promise(((t,r)=>{const s=()=>{if(e<=0)return r(null);e-=1,setTimeout((()=>{this.getPurchase().then((e=>{e.length?t(e):s()})).catch((e=>{console.error(e),s()}))}),1e3*(1+.3*Math.pow(5-e,2)))};s()}))}consumePurchase(e,t=3){return this.server.request("https://bbb.dra.games/api/purchase/ok/close-transaction",{transaction_id:e,app_id:String(this.appId),user_id:this.getId(),sign:this.params}).then((e=>(console.log("consumePurchase",e),!e.error||Promise.reject(e.error)))).catch((r=>(console.error("consumePurchase",r),!(t<=1)&&this.consumePurchase(e,t-1))))}getPurchase(e=1){return this.server.request("https://bbb.dra.games/api/purchase/ok/get-transactions",{app_id:String(this.appId),user_id:this.getId()}).then((e=>(console.log("getPurchase",e),e.error?Promise.reject(e.error):e.data.filter((e=>"closed"!==e.status)).map((e=>({purchaseToken:e.transaction_id,productID:e.data.product_code})))||[]))).catch((t=>(console.error("getPurchase",t),e<=1?[]:this.getPurchase(e-1))))}getCatalogItemData(e){return this.catalog?this.catalog.find((t=>t.id===e)):null}buy(e){const t=this.getCatalogItemData(e)||{};return console.log("BUY",t),this.fapi.UI.showPayment(t.title||"",t.descr||"descr",e,t.priceValue||1,null,JSON.stringify({app_id:this.appId}),"ok","true"),this.eventToPromise("showPayment").then((()=>this.tryGetPurchase())).then((t=>t.find((t=>t.productID===e))||!1)).catch((()=>!1))}eventToPromise(e){const t=[],s=()=>{t.forEach((e=>r.removeListener(e)))};return new Promise(((s,i)=>{const o=(...t)=>{console.error(e,...t),i(t)};t.push(r.addOnceListener(e+"_ok",(t=>{console.log(e+"_ok",t),s(t)}))),t.push(r.addOnceListener(e+"_error",o)),t.push(r.addOnceListener(e+"_cancel",o))})).then((e=>(s(),Promise.resolve(e)))).catch((e=>(s(),Promise.reject(e))))}},console.log("adapter2 =",l),l.init().then((()=>{n=!0,console.log("[success] Адаптер успешно инициализирован")})).catch((e=>{console.error("[error] Ошибка инициализации адаптера:",e)}))})();